<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eKhaya - Your Home, Our Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDF8F0; /* Warm, inviting off-white */
            color: #4A3B31; /* Deep, earthy brown for text */
            overflow: hidden; /* Prevent body scrolling */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .african-pattern-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/aztec.png'); /* Subtle geometric pattern */
            opacity: 0.03;
            z-index: -1;
        }

        .top-bar {
            background-color: rgba(212, 163, 115, 0.8); /* Semi-transparent Ochre */
            backdrop-filter: blur(5px);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative; 
            z-index: 1001; 
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #4A3B31;
        }
        .logo .highlight {
            color: #E76F51; /* Vibrant accent */
        }

        .auth-buttons button {
            background-color: #E76F51;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            transition: background-color 0.3s;
            margin-left: 10px;
            font-size: 0.9rem;
        }
        .auth-buttons button:hover {
            background-color: #D95A3F;
        }
        .auth-buttons .login-btn {
            background-color: transparent;
            color: #4A3B31;
            border: 1px solid #4A3B31;
        }
         .auth-buttons .login-btn:hover {
            background-color: #f0e6d5;
        }


        .hero-carousel-container {
            height: 50vh; 
            width: 100%;
            position: relative;
        }
        .swiper-container {
            width: 100%;
            height: 100%;
        }
        .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .swiper-slide::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.6) 100%);
        }
        .slide-content {
            position: relative;
            z-index: 1;
            color: white;
            padding: 20px;
            max-width: 80%;
        }
        .slide-content h2 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
        }
        .slide-content p {
            font-size: clamp(0.9rem, 2vw, 1.125rem);
            margin-bottom: 1.5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.8);
        }
        .cta-button {
            background-color: #E76F51; 
            color: white;
            padding: 12px 28px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 8px;
            font-size: 1rem;
            border: 2px solid transparent;
        }
        .cta-button:hover {
            background-color: #D95A3F;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .cta-button-secondary {
            background-color: transparent;
            border: 2px solid white;
        }
        .cta-button-secondary:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .icon-hub {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: #F0EFEB; 
        }
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            max-width: 1000px;
            width: 100%;
        }
        .icon-item {
            background-color: #FFFFFF;
            border: 1px solid #D7CCC8; 
            border-radius: 16px; 
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px; 
        }
        .icon-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 20px rgba(0,0,0,0.1);
        }
        .icon-item i { 
            font-size: 2.2rem; 
            margin-bottom: 12px;
            color: #E76F51; 
        }
        .icon-item-svg svg { 
             width: 38px;
             height: 38px;
             margin-bottom: 12px;
             fill: #E76F51; 
        }
        .icon-item span {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4A3B31;
        }
        /* Modal styles */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            display: flex; 
            align-items: center;
            justify-content: center;
            padding: 20px; 
        }

        .modal-content {
            background-color: #FEFDFB; 
            margin: auto; 
            padding: 25px 30px;
            border: 2px solid #D4A373; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 550px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; 
            animation: fadeInModal 0.3s ease-out;
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #4A3B31; 
            text-decoration: none;
        }

        .modal-title {
            color: #BF360C; 
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem; 
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-body p, .modal-body ul li {
            margin-bottom: 12px;
            line-height: 1.7;
            color: #5D4037; 
            font-size: 0.95rem;
        }

        .modal-body img {
            max-width: 100%;
            border-radius: 8px;
            margin: 15px auto;
            display: block;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .modal-body .form-input {
            width: 100%;
            padding: 12px 15px; 
            margin-bottom: 15px;
            border: 1px solid #D4A373; 
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 0.95rem;
        }
        .modal-body .form-input:focus {
            outline: none;
            border-color: #E76F51; 
            box-shadow: 0 0 0 2px rgba(231, 111, 81, 0.2);
        }

        .modal-body .form-button {
            background-color: #E76F51;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
            font-size: 1rem;
        }
        .modal-body .form-button:hover {
            background-color: #D95A3F; /* Darker shade on hover */
        }
        .modal-body .google-signin-btn {
            background-color: #4285F4; /* Google blue */
            color: white;
            margin-top: 10px;
        }
        .modal-body .google-signin-btn:hover {
            background-color: #357AE8; /* Darker Google blue */
        }
        .modal-body .or-divider {
            text-align: center;
            margin: 20px 0;
            color: #8C7A6B; /* Earthy grey */
            font-size: 0.9rem;
            position: relative;
        }
        .modal-body .or-divider::before,
        .modal-body .or-divider::after {
            content: "";
            display: block;
            width: 40%;
            height: 1px;
            background-color: #D7CCC8; /* Light brown */
            position: absolute;
            top: 50%;
        }
        .modal-body .or-divider::before { left: 0; }
        .modal-body .or-divider::after { right: 0; }

        .modal-body .switch-auth-link {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .modal-body .switch-auth-link a {
            color: #E76F51;
            text-decoration: none;
            font-weight: 500;
        }
        .modal-body .switch-auth-link a:hover {
            text-decoration: underline;
        }
        .error-message {
            color: red;
            font-size: 0.875rem;
            margin-top: -10px;
            margin-bottom: 10px;
            text-align: center;
        }

        .swiper-pagination-bullet-active {
            background-color: #E76F51 !important;
        }
        .swiper-button-next, .swiper-button-prev {
            color: #E76F51 !important;
            --swiper-navigation-size: 30px;
        }
        .swiper-button-next:after, .swiper-button-prev:after {
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.5));
        }
        
        /* Custom African Pattern SVGs - simple examples */
        .svg-pattern-1 { /* Ndebele inspired simple diamond */
            width: 40px; height: 40px;
            fill: none; stroke: #795548; stroke-width:2;
        }
         .svg-pattern-2 { /* Simple Hut/Rondavel icon */
            width: 40px; height: 40px;
            fill: #795548;
        }
        .svg-pattern-3 { /* Simple sun/community icon */
            width: 40px; height: 40px;
            fill: #E76F51;
        }

    </style>
</head>
<body>
    <div class="african-pattern-bg"></div>

    <header class="top-bar">
        <div class="logo">e<span class="highlight">K</span>haya</div>
        <div class="auth-buttons">
            <button class="login-btn" onclick="openModal('loginModal')">Login</button>
            <button onclick="openModal('registerModal')">Sign Up</button>
        </div>
    </header>

    <div class="hero-carousel-container">
        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="swiper-slide" style="background-image: url('https://images.unsplash.com/photo-1589087471045-311998588959?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8ZWFzdGVybiUyMGNhcGV8ZW58MHx8MHx8&auto=format&fit=crop&w=1200&q=60');">
                    <div class="slide-content">
                        <h2>Discover the Eastern Cape</h2>
                        <p>Experience the raw beauty and rich Xhosa heritage of the Wild Coast, Amatola Mountains, and beyond. Authentic stays await in welcoming communities.</p>
                        <div>
                            <a href="#" class="cta-button" onclick="openModalWithContent('exploreModal', 'Eastern Cape', 'https://images.unsplash.com/photo-1603202662435-f5133c761416?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8NXx8ZWFzdGVybiUyMGNhcGV8ZW58MHx8MHx8&auto=format&fit=crop&w=800&q=60')">Explore Stays</a>
                            <a href="#" class="cta-button cta-button-secondary" onclick="openModalWithContent('showcaseModal', 'Eastern Cape', 'https://images.unsplash.com/photo-1618284210070-757277617475?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8OHx8ZWFzdGVybiUyMGNhcGUlMjBjdWx0dXJlfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=800&q=60')">Showcase This Region</a>
                        </div>
                    </div>
                </div>
                <div class="swiper-slide" style="background-image: url('https://images.unsplash.com/photo-1586494053092-597990133996?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8M3x8a3dhenVsdSUyMG5hdGFsfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=1200&q=60');">
                    <div class="slide-content">
                        <h2>Majestic KwaZulu-Natal</h2>
                        <p>From the towering Drakensberg peaks to vibrant Zulu villages and sun-kissed coastlines, KZN offers unforgettable adventures.</p>
                         <div>
                            <a href="#" class="cta-button" onclick="openModalWithContent('exploreModal', 'KwaZulu-Natal', 'https://images.unsplash.com/photo-1604973573749-0669f9370415?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8MTB8fGt3YXp1bHUlMjBuYXRhbCUyMGxhbmRzY2FwZXxlbnwwfHwwfHw%3D&auto=format&fit=crop&w=800&q=60')">Explore Stays</a>
                            <a href="#" class="cta-button cta-button-secondary" onclick="openModalWithContent('showcaseModal', 'KwaZulu-Natal', 'https://images.unsplash.com/photo-1589983950357-519208915030?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8NHx8enVsdSUyMGN1bHR1cmV8ZW58MHx8MHx8&auto=format&fit=crop&w=800&q=60')">Showcase This Region</a>
                        </div>
                    </div>
                </div>
                <div class="swiper-slide" style="background-image: url('https://images.unsplash.com/photo-1604814469827-3cc53a008559?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8MXx8bGltcG9wbyUyMHNvdXRoJTIwYWZyaWNlfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=1200&q=60');">
                    <div class="slide-content">
                        <h2>Ancient Limpopo</h2>
                        <p>Land of baobabs, rich wildlife, and the mystical cultures of Venda and Tsonga. Your unique journey starts here.</p>
                         <div>
                            <a href="#" class="cta-button" onclick="openModalWithContent('exploreModal', 'Limpopo', 'https://images.unsplash.com/photo-1547471080-78312f095004?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8YmFvYmFiJTIwdHJlZXxlbnwwfHwwfHw%3D&auto=format&fit=crop&w=800&q=60')">Explore Stays</a>
                            <a href="#" class="cta-button cta-button-secondary" onclick="openModalWithContent('showcaseModal', 'Limpopo', 'https://images.unsplash.com/photo-1623350401185-36956115a821?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8N3x8dmVuZGElMjBjdWx0dXJlfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=800&q=60')">Showcase This Region</a>
                        </div>
                    </div>
                </div>
                 <div class="swiper-slide" style="background-image: url('https://images.unsplash.com/photo-1521791136064-7986c2920216?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Nnx8Y29tbXVuaXR5JTIwZ2F0aGVyaW5nfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=1200&q=60');">
                    <div class="slide-content">
                        <h2>eKhaya: Renting with Ubuntu</h2>
                        <p>Connecting hearts and homes across South Africa. Your journey with us is built on trust, community, and shared prosperity.</p>
                         <div>
                            <a href="#" class="cta-button" onclick="openModal('ourStoryModal')">Our Story</a>
                            <a href="#" class="cta-button cta-button-secondary" onclick="openModal('resourceHubModal')">Get Resources</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </div>

    <div class="icon-hub">
        <div class="icon-grid">
            <div class="icon-item" onclick="openModal('ourStoryModal')">
                <div class="icon-item-svg">
                    <svg class="svg-pattern-1" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 5 L70 25 L50 45 L30 25 Z M50 55 L70 75 L50 95 L30 75 Z M25 50 L45 50 L50 45 L50 55 L45 50 Z M75 50 L55 50 L50 45 L50 55 L55 50 Z" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <span>Our Story</span>
            </div>
            <div class="icon-item" onclick="openModal('findHomeModal')">
                <i class="fas fa-map-marked-alt"></i>
                <span>Find Your eKhaya</span>
            </div>
            <div class="icon-item" onclick="openModal('shareSpaceModal')">
                <div class="icon-item-svg">
                    <svg class="svg-pattern-2" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M10 90 L10 50 A40 40 0 0 1 90 50 L90 90 Z M5 50 L95 50 M30 90 L30 60 A20 10 0 0 1 50 55 A20 10 0 0 1 70 60 L70 90 M40 90 L40 70 Q50 65 60 70 L60 90 "/></svg>
                </div>
                <span>Share Your Space</span>
            </div>
            <div class="icon-item" onclick="openModal('resourceHubModal')">
                <i class="fas fa-book-reader"></i>
                <span>Resource Hub</span>
            </div>
            <div class="icon-item" onclick="openModalWithContent('showcaseModal', 'Your Village', 'https://images.unsplash.com/photo-1543269865-cbf427effbad?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8c291dGglMjBhZnJpY2FuJTIwdmlsbGFnZXxlbnwwfHwwfHw%3D&auto=format&fit=crop&w=800&q=60')">
                <i class="fas fa-camera-retro"></i>
                <span>Showcase Village</span>
            </div>
            <div class="icon-item" onclick="openModal('testimonialsModal')">
                <div class="icon-item-svg">
                     <svg class="svg-pattern-3" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="30"/><circle cx="50" cy="50" r="20" fill="white"/><path d="M50 20 L50 80 M20 50 L80 50 M30 30 L70 70 M30 70 L70 30" stroke="currentColor" stroke-width="5"/></svg>
                </div>
                <span>Community Voices</span>
            </div>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('registerModal')">&times;</span>
            <h3 class="modal-title">Create Your eKhaya Account</h3>
            <div class="modal-body">
                <p>Join our community to find or list unique spaces across South Africa.</p>
                <div id="registerError" class="error-message" style="display:none;"></div>
                <form id="registerForm">
                    <input type="text" id="registerName" placeholder="Full Name" class="form-input" required>
                    <input type="email" id="registerEmail" placeholder="Email Address" class="form-input" required>
                    <input type="password" id="registerPassword" placeholder="Password (min. 6 characters)" class="form-input" required>
                    <input type="password" id="registerConfirmPassword" placeholder="Confirm Password" class="form-input" required>
                    <button type="submit" class="form-button">Register with Email</button>
                </form>
                <div class="or-divider">OR</div>
                <button class="form-button google-signin-btn" onclick="handleGoogleSignUp()">
                    <i class="fab fa-google mr-2"></i> Sign Up with Google
                </button>
                <p class="switch-auth-link mt-4">Already have an account? <a href="#" onclick="switchToLogin()">Log In</a></p>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('loginModal')">&times;</span>
            <h3 class="modal-title">Welcome Back to eKhaya</h3>
            <div class="modal-body">
                <p>Log in to access your profile, listings, and messages.</p>
                <div id="loginError" class="error-message" style="display:none;"></div>
                <form id="loginForm">
                    <input type="email" id="loginEmail" placeholder="Email Address" class="form-input" required>
                    <input type="password" id="loginPassword" placeholder="Password" class="form-input" required>
                    <button type="submit" class="form-button">Log In with Email</button>
                </form>
                <div class="or-divider">OR</div>
                <button class="form-button google-signin-btn" onclick="handleGoogleSignIn()">
                    <i class="fab fa-google mr-2"></i> Sign In with Google
                </button>
                <p class="switch-auth-link mt-4">Don't have an account? <a href="#" onclick="switchToRegister()">Create Account</a></p>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
            <h3 class="modal-title">My eKhaya Profile</h3>
            <div class="modal-body">
                <p>Welcome, <span id="profileUserName" class="font-semibold">User</span>!</p>
                <p>Email: <span id="profileUserEmail" class="font-mono"></span></p>
                <p>User ID: <span id="profileUserId" class="font-mono text-sm bg-gray-100 p-1 rounded"></span></p>
                <button class="form-button mt-6" onclick="handleLogout()">Log Out</button>
                 <button class="form-button mt-4 bg-blue-500 hover:bg-blue-600" onclick="navigateToDashboard()">Go to My Dashboard</button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('infoModal')">&times;</span>
            <h3 id="infoModalTitle" class="modal-title">Notification</h3>
            <div id="infoModalBody" class="modal-body text-center">
                </div>
        </div>
    </div>

    <div id="ourStoryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('ourStoryModal')">&times;</span>
            <h3 class="modal-title">The eKhaya Philosophy</h3>
            <img src="https://images.unsplash.com/photo-1531300900929-673afa703570?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8YWZyaWNhbiUyMGNvbW11bml0eXxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60" alt="Community Hands" class="mx-auto mb-4 rounded-lg shadow-lg">
            <p>eKhaya is more than a platform; it's a movement rooted in the ancient African philosophy of 'Ubuntu' – "I am because we are." We are inspired by the timeless tradition of community, where every person is valued, and hospitality is a sacred duty. In many of our villages, if a traveller was stranded, they were given shelter, food, and sent safely on their way the next morning, not for money, but for the good of all. </p>
            <p>We aim to translate this spirit into the digital age, fostering connections between those who have space and those who seek it. Our focus is on empowering rural and informal property owners, showcasing the beauty and warmth of their communities, and ensuring that both landlords and tenants are treated with fairness and respect. This is about building bridges, not just renting spaces.</p>
        </div>
    </div>

    <div id="findHomeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('findHomeModal')">&times;</span>
            <h3 class="modal-title">Discover Your Next eKhaya</h3>
            <img src="https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YXBhcnRtZW50JTIwaW50ZXJpb3J8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60" alt="Cozy Home Interior" class="mx-auto mb-4 rounded-lg shadow-lg">
            <p>Embark on a journey to find your perfect home or a unique getaway. Our search tools (coming soon!) will help you explore diverse listings across South Africa, with a special emphasis on authentic rural experiences and welcoming small-town properties.</p>
            <p>Whether you're looking for a long-term rental or a short, memorable stay, eKhaya connects you with hosts who embody the spirit of Ubuntu.</p>
            <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                <h4 class="font-semibold text-orange-700">Coming Soon!</h4>
                <p class="text-sm text-orange-600">Our advanced search and filtering options are under development. Soon you'll be able to find your ideal eKhaya with ease!</p>
            </div>
        </div>
    </div>
    
    <div id="shareSpaceModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('shareSpaceModal')">&times;</span>
            <h3 class="modal-title">Share Your Welcoming Space</h3>
            <img src="https://images.unsplash.com/photo-1582694144915-52197b1f501d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGFmcmljYW4lMjBob3NwaXRhbGl0eXxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=500&q=60" alt="Welcoming Hands" class="mx-auto mb-4 rounded-lg shadow-lg">
            <p>Do you have an extra room, a traditional hut, a garden cottage, or a unique space in your rural homestead or town? Open your doors and share the warmth of your eKhaya with travellers and tenants from near and far.</p>
            <p>We provide the tools and support to make listing simple and secure, connecting you with respectful individuals seeking authentic experiences. Be part of a community that celebrates hospitality and mutual benefit.</p>
             <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h4 class="font-semibold text-green-700">Get Ready to Host!</h4>
                <p class="text-sm text-green-600">Our landlord dashboard and listing tools are being crafted with care. Soon you'll be able to showcase your space to the world!</p>
            </div>
        </div>
    </div>

    <div id="resourceHubModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('resourceHubModal')">&times;</span>
            <h3 class="modal-title">eKhaya Knowledge Hub</h3>
            <p class="text-center mb-6">Empowering you with information. Our Resource Hub offers guides, templates, and advice for a smooth rental journey.</p>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-5 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-orange-200">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-balance-scale text-3xl text-orange-500 mr-4"></i>
                        <h4 class="font-semibold text-xl text-gray-700">Legal Ease</h4>
                    </div>
                    <p class="text-sm text-gray-600">Simplified guides to South African rental laws, your rights as a tenant or landlord, and fair practices. Understand leases, deposits, and eviction processes.</p>
                </div>
                <div class="p-5 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-green-200">
                     <div class="flex items-center mb-3">
                        <i class="fas fa-piggy-bank text-3xl text-green-500 mr-4"></i>
                        <h4 class="font-semibold text-xl text-gray-700">Financial Fitness</h4>
                    </div>
                    <p class="text-sm text-gray-600">Tips for budgeting for rent, managing rental income, understanding costs, and planning for a secure financial future.</p>
                </div>
                <div class="p-5 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-blue-200">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-tools text-3xl text-blue-500 mr-4"></i> 
                        <h4 class="font-semibold text-xl text-gray-700">Happy Homes</h4>
                    </div>
                    <p class="text-sm text-gray-600">Advice on property care, essential maintenance, creating welcoming spaces, and tips for harmonious co-living.</p>
                </div>
                <div class="p-5 bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-purple-200">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-users-cog text-3xl text-purple-500 mr-4"></i>
                        <h4 class="font-semibold text-xl text-gray-700">Ubuntu Connect</h4>
                    </div>
                    <p class="text-sm text-gray-600">Learn about dispute resolution, community best practices, and how the spirit of Ubuntu can strengthen landlord-tenant relationships.</p>
                </div>
            </div>
            <p class="text-center mt-6 text-sm text-gray-500">More resources and interactive tools coming soon!</p>
        </div>
    </div>

    <div id="testimonialsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('testimonialsModal')">&times;</span>
            <h3 class="modal-title">Voices from Our eKhaya</h3>
            <p class="text-center mb-6">Real stories from our growing community:</p>
            <div class="space-y-6">
                <div class="p-5 bg-white rounded-lg shadow-md border border-gray-200">
                    <div class="flex items-start mb-2">
                        <img src="https://placehold.co/50x50/D4A373/4A3B31?text=ZM" alt="Zola M." class="rounded-full mr-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">Zola M. - Host, Transkei</h4>
                            <div class="text-yellow-400 text-sm">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm italic text-gray-600">"eKhaya helped me share my traditional Xhosa homestay. It's wonderful to welcome guests and share our culture, just like my grandmother taught me. The platform feels like it truly understands our way of life."</p>
                </div>
                <div class="p-5 bg-white rounded-lg shadow-md border border-gray-200">
                     <div class="flex items-start mb-2">
                        <img src="https://placehold.co/50x50/A8D5BA/4A3B31?text=TN" alt="Thabo N." class="rounded-full mr-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">Thabo N. - Tenant, Gauteng Outskirts</h4>
                            <div class="text-yellow-400 text-sm">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm italic text-gray-600">"Finding a room with a kind landlord was a blessing. The eKhaya resources on tenant rights were so helpful and easy to understand. I feel much more confident now."</p>
                </div>
                 <div class="p-5 bg-white rounded-lg shadow-md border border-gray-200">
                     <div class="flex items-start mb-2">
                        <img src="https://placehold.co/50x50/E76F51/FFFFFF?text=LS" alt="Lerato S." class="rounded-full mr-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">Lerato S. - Guest, Limpopo Village</h4>
                             <div class="text-yellow-400 text-sm">
                                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm italic text-gray-600">"My stay in a Limpopo village, arranged through a local host who learned about eKhaya, was incredible. It's more than just a bed; it's about connection. This platform has so much potential!"</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="genericContentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('genericContentModal')">&times;</span>
            <h3 id="genericModalTitle" class="modal-title">Dynamic Title</h3>
            <div id="genericModalBody" class="modal-body">
                </div>
        </div>
    </div>

    <div id="dashboardPage" class="hidden flex-col items-center justify-center h-full w-full p-8 bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-700">My eKhaya Dashboard</h2>
            
            <div class="mb-6 text-center">
                <p class="text-lg">Welcome, <span id="dashboardUserName" class="font-semibold">User</span>!</p>
                <p class="text-sm text-gray-600">User ID: <span id="dashboardUserId" class="font-mono"></span></p>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Profile Management</h3>
                <p class="text-gray-600 mb-2">Complete your profile to get the most out of eKhaya.</p>
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="openModal('editProfileModal')">
                    Edit My Profile
                </button>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Role Selection</h3>
                <p class="text-gray-600 mb-2">Are you here as a Landlord, Tenant, or both?</p>
                <div class="flex space-x-4">
                    <button class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="selectRole('landlord')">
                        I'm a Landlord
                    </button>
                    <button class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="selectRole('tenant')">
                        I'm a Tenant
                    </button>
                </div>
                 <p class="text-xs text-gray-500 mt-2">You can always switch roles or manage both later.</p>
            </div>

            <div id="landlordDashboardSection" class="hidden mt-6 p-4 border border-gray-300 rounded-lg">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Landlord Dashboard</h4>
                <p class="text-gray-600">Manage your properties, listings, and tenant interactions.</p>
                <button class="mt-2 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="openModal('addPropertyModal')">
                    Add New Property
                </button>
                </div>

            <div id="tenantDashboardSection" class="hidden mt-6 p-4 border border-gray-300 rounded-lg">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Tenant Dashboard</h4>
                <p class="text-gray-600">Search for homes, manage your applications, and communicate with landlords.</p>
                <button class="mt-2 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="openModal('searchPropertiesModal')">
                    Search Properties
                </button>
                </div>

        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('editProfileModal')">&times;</span>
            <h3 class="modal-title">Edit Your Profile</h3>
            <div class="modal-body">
                <form id="profileUpdateForm">
                    <div class="mb-4">
                        <label for="profileDisplayName" class="block text-gray-700 text-sm font-bold mb-2">Display Name:</label>
                        <input type="text" id="profileDisplayName" class="form-input" placeholder="Your Name">
                    </div>
                    <div class="mb-4">
                        <label for="profilePhoneNumber" class="block text-gray-700 text-sm font-bold mb-2">Phone Number (Optional):</label>
                        <input type="tel" id="profilePhoneNumber" class="form-input" placeholder="e.g., 0821234567">
                    </div>
                    <div class="mb-4">
                        <label for="profileBio" class="block text-gray-700 text-sm font-bold mb-2">Short Bio (Optional):</label>
                        <textarea id="profileBio" class="form-input" rows="3" placeholder="Tell us a bit about yourself..."></textarea>
                    </div>
                     <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">I am a:</label>
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="roleTenant" name="userRole" value="tenant" class="mr-2">
                            <label for="roleTenant" class="text-gray-700">Tenant</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="roleLandlord" name="userRole" value="landlord" class="mr-2">
                            <label for="roleLandlord" class="text-gray-700">Landlord</label>
                        </div>
                    </div>
                    <button type="submit" class="form-button">Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <div id="addPropertyModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addPropertyModal')">&times;</span>
            <h3 class="modal-title">Add New Property</h3>
            <div class="modal-body">
                <p>Property listing form will be here. This includes details like address, property type, rent, photos, amenities, etc.</p>
                <form id="addPropertyForm">
                    <button type="submit" class="form-button mt-4">Save Property</button>
                </form>
            </div>
        </div>
    </div>

    <div id="searchPropertiesModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('searchPropertiesModal')">&times;</span>
            <h3 class="modal-title">Search for Properties</h3>
            <div class="modal-body">
                <p>Search filters and results will be displayed here.</p>
                </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile as firebaseUpdateProfile // Renamed to avoid conflict
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc, // Added for updating user roles
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", //  REPLACE WITH YOUR ACTUAL API KEY
            authDomain: "ekhaya-b6fdd.firebaseapp.com",
            projectId: "ekhaya-b6fdd",
            storageBucket: "ekhaya-b6fdd.appspot.com",
            messagingSenderId: "242813323857",
            appId: "1:242813323857:web:3cb499210790b034610670",
            measurementId: "G-4JK8WEQCY7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null; 
        let userProfileData = null; // To store user data from Firestore

        // --- UI Elements ---
        const authButtonsContainer = document.querySelector('.auth-buttons');
        const profileUserNameEl = document.getElementById('profileUserName');
        const profileUserEmailEl = document.getElementById('profileUserEmail');
        const profileUserIdEl = document.getElementById('profileUserId');
        const dashboardUserNameEl = document.getElementById('dashboardUserName');
        const dashboardUserIdEl = document.getElementById('dashboardUserId');
        const landlordDashboardSection = document.getElementById('landlordDashboardSection');
        const tenantDashboardSection = document.getElementById('tenantDashboardSection');
        const mainContentArea = document.querySelector('.hero-carousel-container').parentNode; // Assuming this is the main content area
        const dashboardPage = document.getElementById('dashboardPage');

        // --- Modal Functions ---
        window.openModal = function(modalId) {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "flex";
                // Clear previous error messages
                const errorDivs = modal.querySelectorAll('.error-message');
                errorDivs.forEach(div => {
                    div.style.display = 'none';
                    div.textContent = '';
                });
            }
        }

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "none";
            }
        }

        window.showInfoModal = function(title, message, isError = false) {
            const modalTitle = document.getElementById('infoModalTitle');
            const modalBody = document.getElementById('infoModalBody');
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p class="${isError ? 'text-red-700' : 'text-green-700'}">${message}</p>
                                   <button class="form-button mt-4" onclick="closeModal('infoModal')">OK</button>`;
            openModal('infoModal');
        }
        
        window.openModalWithContent = function(modalType, topic, imageUrl) {
            const modal = document.getElementById('genericContentModal');
            const titleEl = document.getElementById('genericModalTitle');
            const bodyEl = document.getElementById('genericModalBody');
            let title = '';
            let bodyContent = '';

            if (modalType === 'exploreModal') {
                title = `Explore Beautiful ${topic}`;
                bodyContent = `
                    <img src="${imageUrl || 'https://placehold.co/550x300/777/FFF?text=Exploring...'}" alt="Explore ${topic}" class="mx-auto mb-4 rounded-lg shadow-md">
                    <p>Dive into the unique charm of ${topic}. Discover breathtaking landscapes, rich culture, and warm hospitality.</p>
                    <p>Our platform will soon feature detailed listings and travel guides for ${topic}. Imagine finding your perfect rural retreat or authentic homestay here!</p>
                    <button class="mt-4 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" onclick="closeModal('genericContentModal')">Explore Listings (Coming Soon)</button>
                `;
            } else if (modalType === 'showcaseModal') {
                title = `Help Us Showcase ${topic}`;
                 bodyContent = `
                    <img src="${imageUrl || 'https://placehold.co/550x300/888/FFF?text=Showcasing...'}" alt="Showcase ${topic}" class="mx-auto mb-4 rounded-lg shadow-md">
                    <p>Do you have stories, photos, or insights about ${topic} that the world should know? We invite you to contribute to our community showcase!</p>
                    <p>Share what makes your village, town, or region special – from hidden gems, local traditions, to community projects and natural wonders. Let's celebrate the diversity of South Africa together.</p>
                    <button class="mt-4 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" onclick="closeModal('genericContentModal')">Contribute (Coming Soon)</button>
                `;
            }

            titleEl.textContent = title;
            bodyEl.innerHTML = bodyContent;
            openModal('genericContentModal');
        }

        // Close modal if user clicks outside of it
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let i = 0; i < modals.length; i++) {
                if (event.target == modals[i]) {
                    modals[i].style.display = "none";
                }
            }
        }

        // --- Auth UI and State Management ---
        function updateAuthUI(user) {
            if (user) {
                currentUser = user;
                authButtonsContainer.innerHTML = `
                    <span class="text-sm mr-3 text-white">Welcome, ${user.displayName || user.email}!</span>
                    <button onclick="navigateToDashboard()" class="login-btn">Dashboard</button>
                    <button onclick="handleLogout()">Log Out</button>
                `;
                // Populate profile modal (can be enhanced later)
                if (profileUserNameEl) profileUserNameEl.textContent = user.displayName || user.email;
                if (profileUserEmailEl) profileUserEmailEl.textContent = user.email;
                if (profileUserIdEl) profileUserIdEl.textContent = user.uid;
                
                // Populate dashboard placeholders
                if (dashboardUserNameEl) dashboardUserNameEl.textContent = user.displayName || user.email;
                if (dashboardUserIdEl) dashboardUserIdEl.textContent = user.uid;

                // Fetch user profile data from Firestore to determine roles
                fetchUserProfile(user.uid);

            } else {
                currentUser = null;
                userProfileData = null; // Clear profile data on logout
                authButtonsContainer.innerHTML = `
                    <button class="login-btn" onclick="openModal('loginModal')">Login</button>
                    <button onclick="openModal('registerModal')">Sign Up</button>
                `;
                // Hide dashboard and show homepage content if logged out
                if (dashboardPage) dashboardPage.classList.add('hidden');
                if (mainContentArea) mainContentArea.classList.remove('hidden');
            }
        }
        
        async function fetchUserProfile(uid) {
            if (!uid) return;
            try {
                const userDocRef = doc(db, "users", uid);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    userProfileData = docSnap.data();
                    console.log("User profile data:", userProfileData);
                    // Update UI based on roles (e.g., show/hide landlord/tenant sections in dashboard)
                    updateDashboardBasedOnRole();
                    // Pre-fill profile form if editProfileModal is open
                    if (document.getElementById('editProfileModal').style.display === 'flex') {
                        populateProfileForm();
                    }
                } else {
                    console.log("No such user document!");
                    // Handle case where user is authenticated but no Firestore doc (should ideally not happen with current flow)
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
            }
        }

        function updateDashboardBasedOnRole() {
            if (!userProfileData) return;

            if (userProfileData.roles && userProfileData.roles.includes('landlord')) {
                landlordDashboardSection.classList.remove('hidden');
            } else {
                landlordDashboardSection.classList.add('hidden');
            }

            if (userProfileData.roles && userProfileData.roles.includes('tenant')) {
                tenantDashboardSection.classList.remove('hidden');
            } else {
                tenantDashboardSection.classList.add('hidden');
            }
        }
        
        window.navigateToDashboard = function() {
            // Hide homepage content and show dashboard
            if (mainContentArea) mainContentArea.classList.add('hidden');
            if (dashboardPage) dashboardPage.classList.remove('hidden');
            closeModal('profileModal'); // Close profile modal if open
            if (currentUser) {
                fetchUserProfile(currentUser.uid); // Ensure dashboard reflects latest roles
            }
        }

        function navigateToHome() {
            if (dashboardPage) dashboardPage.classList.add('hidden');
            if (mainContentArea) mainContentArea.classList.remove('hidden');
        }


        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                updateAuthUI(user);
            } else {
                updateAuthUI(null);
                navigateToHome(); // If user logs out, go back to home view
            }
        });

        // --- Authentication Functions ---
        window.switchToRegister = function() {
            closeModal('loginModal');
            openModal('registerModal');
        }

        window.switchToLogin = function() {
            closeModal('registerModal');
            openModal('loginModal');
        }

        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const errorDiv = document.getElementById('registerError');
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';

                if (!name) {
                    errorDiv.textContent = "Please enter your full name.";
                    errorDiv.style.display = 'block';
                    return;
                }
                if (password !== confirmPassword) {
                    errorDiv.textContent = "Passwords do not match!";
                    errorDiv.style.display = 'block';
                    return;
                }
                if (password.length < 6) {
                    errorDiv.textContent = "Password should be at least 6 characters.";
                    errorDiv.style.display = 'block';
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await firebaseUpdateProfile(user, { displayName: name });

                    await setDoc(doc(db, "users", user.uid), {
                        uid: user.uid,
                        displayName: name,
                        email: user.email,
                        createdAt: serverTimestamp(),
                        roles: ["tenant"] // Default role, can be changed in profile
                    });

                    console.log("User registered:", user);
                    showInfoModal("Registration Successful!", `Welcome, ${name}! Your account has been created. Please complete your profile.`);
                    closeModal('registerModal');
                    navigateToDashboard(); // Go to dashboard to complete profile
                } catch (error) {
                    console.error("Registration error:", error);
                    errorDiv.textContent = error.message.replace('Firebase: ', ''); // Cleaner error message
                    errorDiv.style.display = 'block';
                }
            });
        }

        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    console.log("User logged in:", userCredential.user);
                    closeModal('loginModal');
                    navigateToDashboard();
                } catch (error) {
                    console.error("Login error:", error);
                    errorDiv.textContent = "Invalid email or password. Please try again."; // User-friendly message
                    errorDiv.style.display = 'block';
                }
            });
        }
        
        window.handleGoogleSignIn = async function() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL || null,
                        createdAt: serverTimestamp(),
                        roles: ["tenant"] // Default role
                    });
                    console.log("New Google user created in Firestore:", user);
                    showInfoModal("Welcome to eKhaya!", `Account created for ${user.displayName}. Please complete your profile.`);
                } else {
                    console.log("Google Sign-In successful:", user);
                     showInfoModal("Login Successful!", `Welcome back, ${user.displayName}!`);
                }
                
                closeModal('loginModal');
                closeModal('registerModal');
                navigateToDashboard();
            } catch (error) {
                console.error("Google Sign-In error:", error);
                let errorMessage = "Google Sign-In failed. Please try again.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google Sign-In cancelled.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Please check your connection and try again.";
                }
                showInfoModal("Google Sign-In Error", errorMessage, true);
            }
        }
        window.handleGoogleSignUp = window.handleGoogleSignIn;

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                console.log("User logged out");
                showInfoModal("Logged Out", "You have been successfully logged out.");
                closeModal('profileModal');
                navigateToHome(); // Ensure user is redirected to home after logout
            } catch (error) {
                console.error("Logout error:", error);
                showInfoModal("Logout Error", error.message, true);
            }
        }

        // --- Profile Management ---
        const profileUpdateForm = document.getElementById('profileUpdateForm');
        if (profileUpdateForm) {
            profileUpdateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showInfoModal("Error", "You must be logged in to update your profile.", true);
                    return;
                }

                const displayName = document.getElementById('profileDisplayName').value.trim();
                const phoneNumber = document.getElementById('profilePhoneNumber').value.trim();
                const bio = document.getElementById('profileBio').value.trim();
                const isTenant = document.getElementById('roleTenant').checked;
                const isLandlord = document.getElementById('roleLandlord').checked;
                
                let roles = [];
                if (isTenant) roles.push('tenant');
                if (isLandlord) roles.push('landlord');
                if (roles.length === 0) roles.push('guest'); // Default to guest if none selected

                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await setDoc(userDocRef, { 
                        displayName: displayName || currentUser.displayName, // Keep existing if blank
                        phoneNumber: phoneNumber || null,
                        bio: bio || null,
                        roles: roles,
                        updatedAt: serverTimestamp()
                    }, { merge: true }); // Merge to avoid overwriting existing fields like email, createdAt

                    // Update Firebase Auth profile if display name changed
                    if (displayName && displayName !== currentUser.displayName) {
                        await firebaseUpdateProfile(currentUser, { displayName: displayName });
                    }
                    
                    showInfoModal("Profile Updated", "Your profile has been successfully updated.");
                    closeModal('editProfileModal');
                    fetchUserProfile(currentUser.uid); // Refresh profile data and dashboard view
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showInfoModal("Profile Update Failed", "Could not update your profile. Please try again.", true);
                }
            });
        }

        window.populateProfileForm = function() {
            if (userProfileData) {
                document.getElementById('profileDisplayName').value = userProfileData.displayName || '';
                document.getElementById('profilePhoneNumber').value = userProfileData.phoneNumber || '';
                document.getElementById('profileBio').value = userProfileData.bio || '';
                document.getElementById('roleTenant').checked = userProfileData.roles?.includes('tenant') || false;
                document.getElementById('roleLandlord').checked = userProfileData.roles?.includes('landlord') || false;
            }
        }
        
        // When opening the edit profile modal, populate it if user data is available
        const editProfileModal = document.getElementById('editProfileModal');
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === "style" && editProfileModal.style.display === "flex" && currentUser) {
                    fetchUserProfile(currentUser.uid).then(populateProfileForm); // Fetch latest then populate
                }
            });
        });
        observer.observe(editProfileModal, { attributes: true });


        window.selectRole = async function(role) {
            if (!currentUser) return;
            
            let newRoles = userProfileData && userProfileData.roles ? [...userProfileData.roles] : [];
            if (!newRoles.includes(role)) {
                newRoles.push(role);
            }
            // If selecting one role, ensure 'guest' is removed if present and not the only role
            if (newRoles.length > 1) {
                newRoles = newRoles.filter(r => r !== 'guest');
            }
            if (newRoles.length === 0) newRoles.push('guest'); // Default to guest if all roles unchecked

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, {
                    roles: newRoles,
                    updatedAt: serverTimestamp()
                });
                showInfoModal("Role Updated", `You are now set as a ${role}.`);
                fetchUserProfile(currentUser.uid); // Refresh dashboard
            } catch (error) {
                console.error("Error updating role:", error);
                showInfoModal("Error", "Could not update your role. Please try again.", true);
            }
        }


        // Initial UI setup
        updateAuthUI(auth.currentUser); // Check initial auth state on load

    </script>
</body>
</html>
